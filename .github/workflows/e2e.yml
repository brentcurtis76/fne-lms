name: End-to-End Testing

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
    types: [labeled]
  workflow_dispatch:
    inputs:
      test_environment:
        description: 'Test environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production
      browsers:
        description: 'Browsers to test'
        required: true
        default: 'chromium,firefox'
        type: string

env:
  NODE_VERSION: '18'
  PLAYWRIGHT_BROWSERS_PATH: ${{ github.workspace }}/ms-playwright

jobs:
  # Only run E2E tests when specifically requested or on main branch
  e2e-tests:
    name: E2E Tests (${{ matrix.browser }})
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'e2e-tests'))

    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        role: [admin, consultor, docente]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install ${{ matrix.browser }} --with-deps

      - name: Build application
        run: npm run build

      - name: Start application
        run: |
          npm run start &
          npx wait-on http://localhost:3000 --timeout 60000
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.TEST_SUPABASE_ANON_KEY }}
          PORT: 3000

      - name: Run E2E tests for ${{ matrix.role }} role on ${{ matrix.browser }}
        run: npx playwright test --project=${{ matrix.browser }} --grep="@${{ matrix.role }}"
        env:
          PLAYWRIGHT_BROWSER: ${{ matrix.browser }}
          TEST_ROLE: ${{ matrix.role }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.TEST_SUPABASE_ANON_KEY }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-results-${{ matrix.browser }}-${{ matrix.role }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

      - name: Upload test videos
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-videos-${{ matrix.browser }}-${{ matrix.role }}
          path: test-results/**/video.webm
          retention-days: 3

  # Visual regression testing
  visual-tests:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'visual-tests')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install chromium --with-deps

      - name: Build application
        run: npm run build

      - name: Start application
        run: |
          npm run start &
          npx wait-on http://localhost:3000 --timeout 60000
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.TEST_SUPABASE_ANON_KEY }}

      - name: Run visual regression tests
        run: npx playwright test --project=visual --update-snapshots
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.TEST_SUPABASE_ANON_KEY }}

      - name: Upload visual diffs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: visual-regression-diffs
          path: test-results/**/diff.png
          retention-days: 7

  # Performance testing
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install chromium --with-deps

      - name: Build application
        run: npm run build

      - name: Start application
        run: |
          npm run start &
          npx wait-on http://localhost:3000 --timeout 60000

      - name: Run Lighthouse CI
        continue-on-error: true
        run: |
          npm install -g @lhci/cli
          lhci autorun || true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Record Lighthouse summary
        run: |
          echo "## âš ï¸ Lighthouse Audit (Non-Blocking)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Lighthouse audit is currently non-blocking while marketing page accessibility/performance issues are addressed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note:** Known issues include buttons without names and large unoptimized images." >> $GITHUB_STEP_SUMMARY

      - name: Run performance tests
        run: npx playwright test --project=performance
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.TEST_SUPABASE_ANON_KEY }}

  # Mobile testing
  mobile-tests:
    name: Mobile Device Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: |
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.pull_request.labels.*.name, 'mobile-tests')

    strategy:
      fail-fast: false
      matrix:
        device: ['iPhone 14', 'Samsung Galaxy S22', 'iPad Pro']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install chromium --with-deps

      - name: Build application
        run: npm run build

      - name: Start application
        run: |
          npm run start &
          npx wait-on http://localhost:3000 --timeout 60000

      - name: Run mobile tests on ${{ matrix.device }}
        run: npx playwright test --project=mobile --grep="${{ matrix.device }}"
        env:
          DEVICE_NAME: ${{ matrix.device }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.TEST_SUPABASE_ANON_KEY }}

      - name: Upload mobile test results
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: mobile-test-results-${{ matrix.device }}
          path: test-results/
          retention-days: 7

  # Accessibility testing
  accessibility-tests:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install chromium --with-deps

      - name: Validate test environment
        id: validate-env
        continue-on-error: true
        run: |
          if [ -z "${{ secrets.TEST_SUPABASE_URL }}" ]; then
            echo "âš ï¸ TEST_SUPABASE_URL not configured - skipping accessibility tests"
            exit 1
          fi
          echo "âœ… Test environment configured"

      - name: Build application
        if: steps.validate-env.outcome == 'success'
        run: npm run build

      - name: Start application
        if: steps.validate-env.outcome == 'success'
        run: |
          npm run start &
          npx wait-on http://localhost:3000 --timeout 60000

      - name: Run accessibility tests
        if: steps.validate-env.outcome == 'success'
        run: npx playwright test --project=accessibility
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.TEST_SUPABASE_ANON_KEY }}

      - name: Generate accessibility report
        run: |
          echo "## â™¿ Accessibility Test Results" >> $GITHUB_STEP_SUMMARY
          echo "Testing WCAG 2.1 AA compliance across all pages" >> $GITHUB_STEP_SUMMARY

  # Test summary for E2E
  e2e-summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: [e2e-tests, visual-tests, performance-tests, mobile-tests, accessibility-tests]
    if: always()

    steps:
      - name: E2E Summary
        run: |
          echo "## ðŸŽ­ End-to-End Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Browser Compatibility Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
            echo "âœ… **Cross-browser tests**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Cross-browser tests**: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### Visual Regression Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.visual-tests.result }}" == "success" ]; then
            echo "âœ… **Visual regression**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“¸ **Visual regression**: CHANGES DETECTED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### Performance Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.performance-tests.result }}" == "success" ]; then
            echo "âš¡ **Performance**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸŒ **Performance**: ISSUES DETECTED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### Mobile Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.mobile-tests.result }}" == "success" ]; then
            echo "ðŸ“± **Mobile compatibility**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸ“± **Mobile compatibility**: ISSUES DETECTED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### Accessibility Tests" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.accessibility-tests.result }}" == "success" ]; then
            echo "â™¿ **Accessibility**: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "â™¿ **Accessibility**: ISSUES DETECTED" >> $GITHUB_STEP_SUMMARY
          fi